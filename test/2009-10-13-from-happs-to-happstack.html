---
title: From HAppS to Happstack
author: Gísli Kristjánsson
tags: haskell
id: 19
timestamp: 13.10.2009 00:13:47
filename: 2009-10-13-from-happs-to-happstack.html
---

<p>I have been dreading porting my Blog application from <em>HAppS</em> to <a href="happstack.com"><em>Happstack</em></a> for a long time now. It is however apparent that <em>HAppS</em> is dying and <em>Happstack</em> (a fork of <em>HAppS</em> designed to take things further) was the only way to roll.</p>
<blockquote><em>... a refreshingly innovative web application server written in Haskell. Leveraging the MACID state system, Happstack offers robust and scalable data access without the headache of managing a traditional RDBMS such as MySQL.</em></blockquote>
<p>The <a href="http://www.darcsweb.com:5003/r/mae/happstack-stable/snapshot/current/content/pretty/happstack/RELEASE_NOTES">RELEASE_NOTES</a> file had some guidelines for porting existing applications to <em>Happstack</em>. In my case it turned out to be really easy:</p>
<ol>
<li>Install <em>Happstack </em> 
<ul>
<li>
<pre>sudo cabal install happstack</pre>
</li>
</ul>
</li>
<li>Change <em>HAppS</em> to <em>Happstack</em> in all .hs-files           
<ul>
<li>
<pre>find . -type f -name '*.hs' -exec sed -i.bak 's/HAppS/Happstack/g' {} \;</pre>
</li>
</ul>
</li>
<li>Change&nbsp;unServerPartT to&nbsp;runServerPartT           
<ul>
<li>
<pre>find . -type f -name '*.hs' -exec sed -i.bak \</pre>
<pre>'s/unServerPartT/runServerPartT/g' {} \;</pre>
</li>
</ul>
</li>
<li>Change all instances of [ServerPartT m a] to ServerPartT with <em>msum</em></li>
<li>Compile my code again</li>
</ol>
<div>Well this sounds almost too easy. And it is. I alway got the error <em>Unsupported socket</em> - both on my Mac (development machine) and on my Linux box (the production machine). On <a href="http://groups.google.com/group/HAppS/msg/0c9a0d0fd7c6aff0"><em>Google Groups</em></a> I found someone saying that it's a problem with how <em>Haskell's Templating System</em> handles &nbsp;<em>IPv6. </em>The solution was to change <em>Happstack.Server.HTTP.Socket.acceptLite</em> to:</div>
<div><br /></div>
<div><span style="color: #000000; font-family: fixed-width, monospace; font-size: 10px; ">&gt; -- | alternative implementation of accept to work around EAI_AGAIN errors&nbsp;<br />&gt; acceptLite :: S.Socket -&gt; IO (Handle, S.HostName, S.PortNumber)&nbsp;<br />&gt; acceptLite sock = do&nbsp;<br />&gt; &nbsp; (sock', addr) &lt;- S.accept sock&nbsp;<br />&gt; &nbsp; h &lt;- S.socketToHandle sock' ReadWriteMode&nbsp;<br />&gt; &nbsp; (N.PortNumber p) &lt;- N.socketPort sock'&nbsp;<br />
<p>&gt; &nbsp; let peer = case addr of&nbsp;<br />&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;(S.SockAddrInet _ ha) &nbsp; &nbsp; &nbsp;-&gt; showHostAddress ha&nbsp;<br />&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;(S.SockAddrInet6 _ _ ha _) -&gt; showHostAddress6 ha&nbsp;<br />&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;_ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; error "Unsupported socket"</p>
<p>&gt; &nbsp; return (h, peer, p)&nbsp;</p>
</span></div>
<div>Actually I used the time to cabalize my code. Outlining the dependencies means that <em><a href="http://www.haskell.org/cabal">Cabal</a></em> takes care of downloading all the necessary packages. To date my cabal file looks like this:</div>

<pre>
name: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;gisliblog<br/>
version: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0.0
synopsis: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Personal website
description: &nbsp; &nbsp; &nbsp; &nbsp; 
category: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Web
license: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; BSD3
license-file: &nbsp; &nbsp; &nbsp; &nbsp;LICENSE
author: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;G&iacute;sli Kristj&aacute;nsson
maintainer: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;gislik hamstur.is
build-depends: &nbsp; &nbsp; &nbsp; base,feed,nano-md5,hscolour,json,curl,HStringTemplate,happstack
build-type: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Simple
hs-source-dirs:   &nbsp; &nbsp; src
executable: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;gisli.hamstur.is
main-is: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; src/Main.hs
ghc-options:     &nbsp; &nbsp; -isrc &nbsp; &nbsp; &nbsp; &nbsp;</pre>

<div>Also having everything in a <em><a href="http://git-scm.com/">git</a></em>&nbsp;repository meant that I could port the code in a special branch and merge the branches when the code compiled successfully. The next steps are to port my brothers photo site to <em>Happstack</em> and then look into taking the advantage of the new API which has been simplified in many ways. For example</div>
<div><br /></div>
<div>This:</div>
<pre>&nbsp;&nbsp; &nbsp;uriRest :: Monad m =&gt; (String -&gt; ServerPartT m a) -&gt; ServerPartT m a</pre>
<pre>&nbsp;&nbsp; &nbsp;uriRest handle = withRequest $ \rq -&gt;</pre>
<pre>&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;unServerPartT (handle (rqURL rq)) rq</pre>
<div>Becomes this:</div>
<pre>&nbsp;&nbsp; &nbsp;uriRest :: (ServerMonad m, Monad m) =&gt; (String -&gt; m a) -&gt; m a</pre>
<pre>&nbsp;&nbsp; &nbsp;uriRest handle = askRq &gt;&gt;= handle . rqURL</pre>
<p>&nbsp;</p>
<div>That's it for now.</div>
<div><br /></div>
<div>P.S. On a different note I just placed an order for the <em>Arduino Duemilanove</em> microcontroller board. It should be arriving this week. I'm all excited so the next blog could be about that.</div>



